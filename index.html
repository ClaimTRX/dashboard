<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CFT Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      background-color: #1a1a2e;
      color: #fff;
    }

    .sidebar {
      height: 100vh;
      background-color: #162447;
      padding: 15px;
    }

    .sidebar a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 10px 0;
    }

    .sidebar a:hover {
      background-color: #1f4068;
    }

    .topbar {
      background-color: #162447;
      padding: 10px;
      text-align: right;
    }

    .topbar button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      padding: 10px 20px;
    }

    .card {
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 10px;
    }

    .card-title {
      font-size: 1.5rem;
    }

    .card-text {
      font-size: 1.2rem;
    }

    .btn-success, .btn-warning {
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      padding: 10px 20px;
    }

    .btn-warning {
      background-color: #FF5733;
    }
  </style>
</head>
<body>
  <div class="d-flex">
    <div class="sidebar">
      <h2>CFT</h2>
      <a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="#"><i class="fas fa-user"></i> Profile</a>
      <a href="#"><i class="fas fa-cog"></i> Settings</a>
    </div>
    <div class="flex-grow-1">
      <div class="topbar">
        <button id="connectWallet">Connect Wallet</button>
      </div>
      <div class="container">
        <h1>Welcome to the Dashboard</h1>
        <!-- Reward Box -->
        <div class="card mt-4">
          <div class="card-body">
            <h5 class="card-title">Claimable Staking Rewards</h5>
            <p class="card-text" id="userRewards">Loading...</p>
            <button id="claimRewardsButton" class="btn btn-success">Claim Rewards</button>
          </div>
        </div>
        <!-- Staked Tokens and Available CFT -->
        <div class="card mt-4">
          <div class="card-body">
            <h5 class="card-title">Staked Tokens and Available CFT</h5>
            <p class="card-text" id="userStakedBalance">Loading...</p>
            <p class="card-text" id="unstakedBalance">Loading...</p>
            <p class="card-text">Current APY: <span id="currentAPR">Loading...</span>%</p>
            <input type="number" id="stakeAmount" placeholder="Amount to stake" class="form-control mb-2">
            <button id="approveAndStakeButton" class="btn btn-success">Stake</button>
            <input type="number" id="withdrawAmount" placeholder="Amount to withdraw" class="form-control mb-2 mt-2">
            <button id="withdrawButton" class="btn btn-warning">Unstake</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.min.js"></script>
  <script>
    let tronWeb;
    let stakingContract;
    let tokenContract;
    const stakingContractAbi = [/* ABI of your staking contract */];
    const stakingContractAddress = 'TVSMKqBk12161JDAQBh9pkdxMAgCtuGrdA';
    const tokenContractAbi = [/* ABI of your token contract */];
    const tokenContractAddress = 'TAQzALyftaynnr3VG3rCvzkY2KouFH79sA';

    document.addEventListener('DOMContentLoaded', async () => {
      await connectWallet();
    });

    async function connectWallet() {
      if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
        tronWeb = window.tronWeb;
        const walletAddress = tronWeb.defaultAddress.base58;
        $('#connectWallet').text(`Connected`);
        $('#connectWallet').prop('disabled', true);
        stakingContract = await tronWeb.contract(stakingContractAbi, stakingContractAddress);
        tokenContract = await tronWeb.contract(tokenContractAbi, tokenContractAddress);
        await updateStakingInfo();
      } else {
        console.log('Please install TronLink and log in.');
      }
    }

    async function updateStakingInfo() {
      try {
        const totalStaked = await stakingContract.methods.viewTotalStaked().call();
        const userStakedBalance = await stakingContract.methods.viewStakedAmount(tronWeb.defaultAddress.base58).call();
        const userRewards = await stakingContract.methods.viewPendingReward(tronWeb.defaultAddress.base58).call();
        const unstakedBalance = await tokenContract.methods.balanceOf(tronWeb.defaultAddress.base58).call();
        const currentAPR = await stakingContract.methods.viewAPR().call();

        const totalStakedValue = tronWeb.fromSun(totalStaked);
        const userStakedBalanceValue = tronWeb.fromSun(userStakedBalance);
        const userRewardsValue = tronWeb.fromSun(userRewards);
        const unstakedBalanceValue = tronWeb.fromSun(unstakedBalance);
        const currentAPRValue = currentAPR / 1e4;

        $('#userStakedBalance').text(userStakedBalanceValue.toFixed(2) + " CFT");
        $('#userRewards').text(userRewardsValue.toFixed(2) + " TRX");
        $('#unstakedBalance').text(unstakedBalanceValue.toFixed(2) + " CFT");
        $('#currentAPR').text(currentAPRValue.toFixed(2));
      } catch (error) {
        console.error('Error updating staking info:', error);
      }
    }

    async function approveAndStakeTokens() {
      const amount = $('#stakeAmount').val();
      if (amount <= 0) return alert('Please enter a valid amount to stake.');

      try {
        const allowance = await tokenContract.methods.allowance(tronWeb.defaultAddress.base58, stakingContractAddress).call();
        const amountToStake = tronWeb.toSun(amount);
        const maxUint256 = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

        if (allowance < amountToStake) {
          await tokenContract.methods.approve(stakingContractAddress, maxUint256).send();
        }

        await stakingContract.methods.stake(amountToStake).send();
        await updateStakingInfo();
        alert('Tokens approved and staked successfully.');
      } catch (error) {
        console.error('Error approving and staking tokens:', error);
      }
    }

    async function withdrawTokens() {
      const amount = $('#withdrawAmount').val();
      if (amount <= 0) return alert('Please enter a valid amount to withdraw.');

      try {
        await stakingContract.methods.withdraw(tronWeb.toSun(amount)).send();
        await updateStakingInfo();
      } catch (error) {
        console.error('Error withdrawing tokens:', error);
      }
    }

    async function claimRewards() {
      try {
        await stakingContract.methods.claimReward().send();
        await updateStakingInfo();
      } catch (error) {
        console.error('Error claiming rewards:', error);
      }
    }

    $(document).ready(function() {
      $('#connectWallet').on('click', connectWallet);
      $('#approveAndStakeButton').on('click', approveAndStakeTokens);
      $('#withdrawButton').on('click', withdrawTokens);
      $('#claimRewardsButton').on('click', claimRewards);
    });
  </script>
</body>
</html>
