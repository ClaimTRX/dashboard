<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CFT Token</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    body {
      background-color: #1a1a2e;
      color: #fff;
    }

    .sidebar {
    height: 100vh;
    background-color: #162447;
    padding: 15px;
    position: fixed;
    width: 200px;
}

.sidebar a {
    color: #fff;
    text-decoration: none;
    display: block;
    padding: 10px 0;
}

.sidebar a:hover {
    background-color: #1f4068;
}

.sidebar .social-links {
    margin-top: 20px;
}

.sidebar .social-icon {
    color: white;
    font-size: 20px;
    margin-right: 10px;
    text-decoration: none;
}
    .topbar {
    background-color: #162447;
    padding: 10px;
    text-align: right;
    margin-left: 200px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
}

    .topbar a.social-icon {
    color: white;
    margin-left: 15px;
    font-size: 20px;
    text-decoration: none;
}

    .topbar button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      padding: 8px 16px;
    }

    .main-content {
      margin-left: 220px;
      padding: 20px;
    }

    .card {
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 20px;
    }

    .card-body {
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1.5rem;
    }

    .card-text {
      font-size: 1rem;
    }

    .btn-success, .btn-danger, .btn-primary {
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.875rem;
      padding: 8px 16px;
      width: 20%; /* Adjust width */
      margin-top: 10px;
    }

    .btn-danger {
      background-color: #ff4c4c;
    }

    .btn-primary {
      background-color: #007bff;
    }

    .form-control {
      width: 20%; /* Adjust width */
      padding: 8px;
      font-size: 0.875rem;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .card-explanation {
      margin-top: 10px;
      font-size: 0.875rem;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .listing {
      background-color: #1f4068;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .listing button {
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.875rem;
  padding: 8px 16px;
  width: 20%; /* Adjust width for better appearance */
  margin-top: 10px; /* Add some margin to space them out */
}

    .listing .btn-success {
  background-color: #4CAF50;
}
    .listing .btn-danger {
  background-color: #ff4c4c;
}

    /* Mobile responsiveness */
@media (max-width: 767.98px) {
  .listing button {
    font-size: 0.75rem;
    padding: 6px 12px;
    width: 100%; /* Full width for mobile */
  }
}
    @media (min-width: 768px) {
      .card-body {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }

      .card-text-section {
        flex: 1;
        margin-right: 20px;
      }

      .card-explanation {
        flex: 1;
      }
    }

    @media (max-width: 767.98px) {
    .sidebar {
        height: auto;
        padding: 10px;
        width: 100%;
        position: relative;
    }

    .topbar {
        text-align: center; /* Center text on mobile devices */
        margin-left: 0;
        justify-content: center;
    }

    .main-content {
        margin-left: 0;
    }

    .card-title {
        font-size: 1.25rem;
    }

    .card-text {
        font-size: 0.875rem;
    }

    .btn-success, .btn-danger, .btn-primary {
        font-size: 0.75rem;
        padding: 6px 12px;
        width: 100%; /* Adjust width for mobile */
    }

    .form-control {
        font-size: 0.75rem;
        padding: 6px;
        width: 100%; /* Adjust width for mobile */
    }

    .card-explanation {
        margin-top: 20px;
    }


    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>CFT Token</h2>
    <a href="index.html">CFT Token</a>
    <a href="lottery.html">Lottery</a>
    <a href="draw.html">Draw</a>
    <a href="claim.html">Claim (Coming Soon)</a>
    <div class="social-links">
        <a href="https://x.com/cfttrc20?s=21" target="_blank" class="social-icon">
            <i class="fab fa-twitter"></i>
        </a>
        <a href="https://t.me/claimfreetrxnow" target="_blank" class="social-icon">
            <i class="fab fa-telegram-plane"></i>
        </a>
    </div>
  </div>
  <div class="topbar">
    <button id="connect-button" onclick="connectWallet()">Connect Wallet</button>
    
  </div>
  <div class="main-content">
    <h1>CFT Token</h1>
    <!-- Reward Box -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="card-text-section">
          <h5 class="card-title">Claimable Staking Rewards</h5>
          <p class="card-text" id="claimable-rewards">Loading...</p>
          <h5 class="card-title mt-3">Current APR</h5>
          <p class="card-text" id="current-apr">Loading...</p>
          <h5 class="card-title mt-3">Your Staked CFT</h5>
          <p class="card-text" id="staked-amount">Loading...</p>
          <h5 class="card-title mt-3">Total Staked CFT</h5>
          <p class="card-text" id="total-staked-amount">Loading...</p>
          <button id="claim-rewards-button" class="btn btn-success">Claim Rewards</button><br>
          <button id="compound-button" class="btn btn-success">Claim and buy CFT</button>
        </div>
        <div class="card-explanation">
          <p>TRX rewards are generated by our treasury, it can be claimed anytime but make sure you have enough Energy to do so.<br>
The energy costs are:</p>
<p>- To Claim: 55,000 Energy<br>
- To Claim and Buy CFT: 80,000 Energy<br>
</p>
          

        </div>
      </div>
    </div>
    <!-- Stake/Unstake Box -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="card-text-section">
          <h5 class="card-title">Stake/Unstake CFT</h5>
          <p class="card-text" id="available-cft">Loading...</p>
          <input type="number" id="stake-amount" class="form-control" placeholder="Enter amount ">
          <button id="stake-button" class="btn btn-success">Stake</button><br>
          <button id="unstake-button" class="btn btn-danger">Unstake</button>
        </div>
        <div class="card-explanation">
          <p>To Stake or Unstake your CFT you need energy in your wallet, When staking you need to sign two transactions, one to approve CFT token and one to Stake.</p>
          <p>Staking cost are:<br>
            -Approve and stake: 85,000 Energy <br>
            - Unstake your CFT: 50,000 Energy </p>
        </div>
      </div>
    </div>
    <!-- Buy Box -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="card-text-section">
          <h5 class="card-title">Buy CFT</h5>
          <p class="card-text">Current CFT Price: 1 TRX</p>
          <p class="card-text" id="available-trx">Loading...</p>
          <h5 class="card-title mt-3">Total CFT Tokens in Buy Contract</h5>
<p class="card-text" id="total-buy-cft">Loading...</p>

          <input type="number" id="buy-amount" class="form-control" placeholder="Enter amount to buy">
          <button id="buy-button" class="btn btn-primary">Buy CFT</button>
        </div>
        <div class="card-explanation">
          <p>This card shows the current price of CFT tokens in TRX and the amount of TRX you have available. Enter the amount of CFT tokens you want to buy and click the "Buy CFT" button.</p>
        </div>
      </div>
    </div>
   <!-- Marketplace Box -->
<div class="card mt-4">
  <div class="card-body">
    <div class="card-text-section">
      <h5 class="card-title">Marketplace</h5>
      <p class="card-text">List or Buy CFT Tokens</p>
      <input type="number" id="tokenAmount" class="form-control" placeholder="Amount of Tokens">
      <input type="number" id="pricePerTokenInTRX" class="form-control" placeholder="Total price in TRX">
      <button id="approveAndListButton" class="btn btn-success">Approve and List</button>
    </div>
    <div class="card-explanation">
      <p>Approve the tokens you want to list on the marketplace. Once approved, you can list them for sale at your desired price per token.</p>
    </div>
  </div>
</div>

<!-- Listed for Sale Box -->
<div class="card mt-4">
  <div class="card-body">
    <div class="card-text-section">
      <h5 class="card-title">Listed for Sale</h5>
      <div id="listings" class="card-text">Loading...</div>
    </div>
    <div class="card-explanation">
      <p>Approve the tokens you want to list on the marketplace. Once approved, you can list them for sale at your desired price per token.</p>
    </div>
  </div>
</div>



  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.min.js"></script>
  <script>
    let tronWeb, userAddress, stakingContract, tokenContract, buyCftContract, marketplaceContract;
    const stakingContractAddress = 'TVSMKqBk12161JDAQBh9pkdxMAgCtuGrdA';
    const tokenContractAddress = 'TAQzALyftaynnr3VG3rCvzkY2KouFH79sA';
    const buyCftContractAddress = 'TNd9QQNUUENTQWCs81yan3ttzahQXHJhAC';
    const marketplaceContractAddress = 'TQaF95pNKxZp8HEVKT7Y4V9WMJYofsEKra';
    const maxUint256 = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';




    const stakingContractAbi = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_stakingToken",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "RewardClaimed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "Staked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "Withdrawn",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "OwnerWithdrawn",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "stake",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "claimReward",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "ownerWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "viewAPR",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "viewTotalStaked",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "viewStakedAmount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "viewPendingReward",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_dailyReward",
                        "type": "uint256"
                    }
                ],
                "name": "setDailyReward",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];

    
    const tokenContractAbi = [
    {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [],
        "name": "name",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "symbol",
        "outputs": [
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "decimals",
        "outputs": [
            {
                "internalType": "uint8",
                "name": "",
                "type": "uint8"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "totalSupply",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "owner",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "taxAddress",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "taxRate",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "whitelist",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "balanceOf",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "allowance",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transfer",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_spender",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "approve",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_from",
                "type": "address"
            },
            {
                "internalType": "address",
                "name": "_to",
                "type": "address"
            },
            {
                "internalType": "uint256",
                "name": "_value",
                "type": "uint256"
            }
        ],
        "name": "transferFrom",
        "outputs": [
            {
                "internalType": "bool",
                "name": "success",
                "type": "bool"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_taxRate",
                "type": "uint256"
            }
        ],
        "name": "setTaxRate",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_taxAddress",
                "type": "address"
            }
        ],
        "name": "setTaxAddress",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_account",
                "type": "address"
            },
            {
                "internalType": "bool",
                "name": "_isWhitelisted",
                "type": "bool"
            }
        ],
        "name": "updateWhitelist",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "from",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "to",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Transfer",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "owner",
                "type": "address"
            },
            {
                "indexed": true,
                "internalType": "address",
                "name": "spender",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "value",
                "type": "uint256"
            }
        ],
        "name": "Approval",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "oldRate",
                "type": "uint256"
            },
            {
                "indexed": false,
                "internalType": "uint256",
                "name": "newRate",
                "type": "uint256"
            }
        ],
        "name": "TaxRateChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": false,
                "internalType": "address",
                "name": "oldAddress",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "address",
                "name": "newAddress",
                "type": "address"
            }
        ],
        "name": "TaxAddressChanged",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {
                "indexed": true,
                "internalType": "address",
                "name": "account",
                "type": "address"
            },
            {
                "indexed": false,
                "internalType": "bool",
                "name": "isWhitelisted",
                "type": "bool"
            }
        ],
        "name": "WhitelistUpdated",
        "type": "event"
    }
];
    
    const buyCftContractAbi = [
        {
            "inputs": [
                {
                    "internalType": "contract ITRC20",
                    "name": "_token",
                    "type": "address"
                },
                {
                    "internalType": "uint256",
                    "name": "_tokenPrice",
                    "type": "uint256"
                }
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "amount",
                    "type": "uint256"
                }
            ],
            "name": "withdrawTRX",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "amount",
                    "type": "uint256"
                }
            ],
            "name": "withdrawTokens",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "buyTokens",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
        },
        {
            "stateMutability": "payable",
            "type": "receive"
        }
    ];

  
  const marketplaceContractAbi = [ {
  "inputs": [
    {
      "internalType": "address",
      "name": "tokenAddress",
      "type": "address"
    }
  ],
  "stateMutability": "nonpayable",
  "type": "constructor"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "tokenAmount",
      "type": "uint256"
    },
    {
      "internalType": "uint256",
      "name": "priceInTRX",
      "type": "uint256"
    }
  ],
  "name": "listToken",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "listingId",
      "type": "uint256"
    }
  ],
  "name": "buyToken",
  "outputs": [],
  "stateMutability": "payable",
  "type": "function"
},
{
  "inputs": [
    {
      "internalType": "uint256",
      "name": "listingId",
      "type": "uint256"
    }
  ],
  "name": "cancelListing",
  "outputs": [],
  "stateMutability": "nonpayable",
  "type": "function"
},
{
  "inputs": [],
  "name": "getActiveListings",
  "outputs": [
    {
      "internalType": "uint256[]",
      "name": "",
      "type": "uint256[]"
    },
    {
      "components": [
        {
          "internalType": "address",
          "name": "seller",
          "type": "address"
        },
        {
          "internalType": "uint128",
          "name": "tokenAmount",
          "type": "uint128"
        },
        {
          "internalType": "uint128",
          "name": "priceInTRX",
          "type": "uint128"
        },
        {
          "internalType": "bool",
          "name": "isActive",
          "type": "bool"
        }
      ],
      "internalType": "struct TokenMarketplace.Listing[]",
      "name": "",
      "type": "tuple[]"
    }
  ],
  "stateMutability": "view",
  "type": "function"
}
];

   document.addEventListener('DOMContentLoaded', async () => {
    if (await checkTronLinkInstalled()) {
        await initializeTronWeb();
    }
});

async function checkTronLinkInstalled() {
    return new Promise((resolve) => {
        const interval = setInterval(() => {
            if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                clearInterval(interval);
                resolve(true);
            }
        }, 1000);
    });
}

async function initializeTronWeb() {
    tronWeb = window.tronWeb;
    userAddress = tronWeb.defaultAddress.base58;

    document.getElementById('connect-button').style.display = 'none'; // Hide the button

    console.log('Connected to TronLink.');
    console.log('User Address:', userAddress);

    try {
        const balance = await tronWeb.trx.getBalance(userAddress);
        console.log('Balance:', tronWeb.fromSun(balance), 'TRX');

        // Initialize contracts
        stakingContract = await tronWeb.contract(stakingContractAbi, stakingContractAddress);
        tokenContract = await tronWeb.contract(tokenContractAbi, tokenContractAddress);
        buyCftContract = await tronWeb.contract(buyCftContractAbi, buyCftContractAddress);
        marketplaceContract = await tronWeb.contract(marketplaceContractAbi, marketplaceContractAddress);

        updateUI(balance);
    } catch (error) {
        console.error('Error fetching balance:', error);
    }
}


async function updateUI(balance) {
    try {
        await updateClaimableRewards();
        await updateAPR();
        await updateStakedAmount();
        await updateAvailableCFT();
        await updateTotalStakedAmount();
        await updateTotalBuyCFT();
        updateAvailableTRX(balance);
        fetchMarketplaceListings();

        setupEventListeners();
    } catch (error) {
        console.error('Error updating UI:', error);
    }
}

async function updateClaimableRewards() {
    const claimableRewards = await stakingContract.methods.viewPendingReward(userAddress).call();
    document.getElementById('claimable-rewards').innerText = formatWholeNumber(tronWeb.fromSun(claimableRewards)) + ' TRX';
}

async function updateTotalStakedAmount() {
    const totalStakedAmount = await stakingContract.methods.viewTotalStaked().call();
    document.getElementById('total-staked-amount').innerText = formatWholeNumber(tronWeb.fromSun(totalStakedAmount)) + ' CFT';
}

async function updateAPR() {
    const currentAPR = await stakingContract.methods.viewAPR().call();
    document.getElementById('current-apr').innerText = formatAPR(currentAPR) + ' %';
}

async function updateStakedAmount() {
    const stakedAmount = await stakingContract.methods.viewStakedAmount(userAddress).call();
    document.getElementById('staked-amount').innerText = formatWholeNumber(tronWeb.fromSun(stakedAmount)) + ' CFT';
}

async function updateAvailableCFT() {
    const availableCFT = await tokenContract.methods.balanceOf(userAddress).call();
    document.getElementById('available-cft').innerText = 'Available CFT: ' + formatWholeNumber(tronWeb.fromSun(availableCFT)) + ' CFT';
}

async function updateTotalBuyCFT() {
    try {
        const totalBuyCFT = await tokenContract.methods.balanceOf(buyCftContractAddress).call();
        document.getElementById('total-buy-cft').innerText = formatWholeNumber(tronWeb.fromSun(totalBuyCFT)) + ' CFT';
    } catch (error) {
        console.error('Error fetching total CFT tokens in buy contract:', error);
    }
}


function updateAvailableTRX(balance) {
    document.getElementById('available-trx').innerText = 'Available TRX: ' + formatWholeNumber(tronWeb.fromSun(balance)) + ' TRX';
}

function setupEventListeners() {
    document.getElementById('stake-button').addEventListener('click', async () => {
        const stakeAmount = document.getElementById('stake-amount').value;
        if (stakeAmount) {
            try {
                await stakeTokens(stakeAmount);
                setTimeout(refreshUI, 3000);
            } catch (error) {
                console.error('Error staking tokens:', error);
            }
        }
    });

    document.getElementById('unstake-button').addEventListener('click', async () => {
        try {
            await unstakeTokens();
            setTimeout(refreshUI, 3000);
        } catch (error) {
            console.error('Error unstaking tokens:', error);
        }
    });

    document.getElementById('claim-rewards-button').addEventListener('click', async () => {
        try {
            await claimRewards();
            setTimeout(refreshUI, 3000);
        } catch (error) {
            console.error('Error claiming rewards:', error);
        }
    });

    document.getElementById('buy-button').addEventListener('click', async () => {
        const buyAmount = document.getElementById('buy-amount').value;
        if (buyAmount) {
            try {
                await buyTokens(buyAmount);
                setTimeout(refreshUI, 3000);
            } catch (error) {
                console.error('Error buying tokens:', error);
            }
        }
    });

    document.getElementById('compound-button').addEventListener('click', async () => {
        try {
            await compoundRewards();
            setTimeout(refreshUI, 3000);
        } catch (error) {
            console.error('Error compounding rewards:', error);
        }
    });

    document.getElementById('approveAndListButton').addEventListener('click', async () => {
        const tokenAmount = document.getElementById('tokenAmount').value;
        const pricePerTokenInTRX = document.getElementById('pricePerTokenInTRX').value;

        if (tokenAmount && pricePerTokenInTRX) {
            try {
                await approveAndListTokens(tokenAmount, pricePerTokenInTRX);
                setTimeout(refreshUI, 3000);
            } catch (error) {
                console.error('Error listing tokens:', error);
            }
        }
    });
}

async function stakeTokens(amount) {
    const allowance = await tokenContract.methods.allowance(userAddress, stakingContractAddress).call();
    const amountToStake = tronWeb.toSun(amount);

    if (allowance < amountToStake) {
        await tokenContract.methods.approve(stakingContractAddress, maxUint256).send();
    }

    await stakingContract.methods.stake(amountToStake).send();
    const newStakedAmount = await stakingContract.methods.viewStakedAmount(userAddress).call();
    document.getElementById('staked-amount').innerText = formatWholeNumber(tronWeb.fromSun(newStakedAmount)) + ' CFT';
}

async function unstakeTokens() {
    const unstakeAmount = document.getElementById('stake-amount').value;
    await stakingContract.methods.withdraw(tronWeb.toSun(unstakeAmount)).send();
    const newStakedAmount = await stakingContract.methods.viewStakedAmount(userAddress).call();
    document.getElementById('staked-amount').innerText = formatWholeNumber(tronWeb.fromSun(newStakedAmount)) + ' CFT';
}

async function claimRewards() {
    await stakingContract.methods.claimReward().send();
    const newClaimableRewards = await stakingContract.methods.viewPendingReward(userAddress).call();
    document.getElementById('claimable-rewards').innerText = formatWholeNumber(tronWeb.fromSun(newClaimableRewards)) + ' TRX';
}

async function buyTokens(amount) {
    await buyCftContract.methods.buyTokens().send({
        callValue: tronWeb.toSun(amount)
    });
    const newBalance = await tronWeb.trx.getBalance(userAddress);
    document.getElementById('available-trx').innerText = 'Available TRX: ' + formatWholeNumber(tronWeb.fromSun(newBalance)) + ' TRX';
}

async function compoundRewards() {
    await stakingContract.methods.claimReward().send();
    const claimableRewards = await stakingContract.methods.viewPendingReward(userAddress).call();

    await buyCftContract.methods.buyTokens().send({
        callValue: claimableRewards
    });

    setTimeout(refreshUI, 3000);
}

async function fetchMarketplaceListings() {
    try {
        const result = await marketplaceContract.methods.getActiveListings().call();
        const listingIds = result[0];
        const listings = result[1];

        const listingsContainer = document.getElementById('listings');
        listingsContainer.innerHTML = '';

        for (let i = 0; i < listingIds.length; i++) {
            const listingId = listingIds[i];
            const listing = listings[i];

            if (listing.isActive) {
                const tokenAmount = tronWeb.fromSun(listing.tokenAmount);
                const totalPrice = tronWeb.fromSun(listing.priceInTRX);
                const isSeller = listing.seller.trim().toLowerCase() === userAddress.trim().toLowerCase();

                const listingElement = document.createElement('div');
                listingElement.className = 'listing';
                listingElement.innerHTML = `
                    <p>Seller: ${listing.seller}</p>
                    <p>Token Amount: ${tokenAmount}</p>
                    <p>Total Price: ${totalPrice} TRX</p>
                    <button class="btn btn-success mb-2" onclick="buyToken(${listingId}, ${totalPrice})">Buy</button>
                    ${isSeller ? `<button class="btn btn-danger" onclick="cancelListing(${listingId})">Cancel</button>` : ''}
                `;
                listingsContainer.appendChild(listingElement);
            }
        }
    } catch (error) {
        console.error(error);
        alert('Failed to fetch listings.');
    }
}

async function buyToken(listingId, totalPrice) {
    try {
        await marketplaceContract.methods.buyToken(listingId).send({
            callValue: tronWeb.toSun(totalPrice)
        });

        alert('Token purchased successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error('Error buying token:', error);
        alert('Failed to buy tokens.');
    }
}

async function cancelListing(listingId) {
    try {
        await marketplaceContract.methods.cancelListing(listingId).send();
        alert('Listing cancelled successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error('Error cancelling listing:', error);
        alert('Failed to cancel listing.');
    }
}

async function approveAndListTokens(tokenAmount, priceInTRX) {
    const adjustedTokenAmount = tronWeb.toSun(tokenAmount);
    const adjustedPriceInTRX = tronWeb.toSun(priceInTRX);

    try {
        await tokenContract.methods.approve(marketplaceContractAddress, adjustedTokenAmount).send();
        await marketplaceContract.methods.listToken(adjustedTokenAmount, adjustedPriceInTRX).send();
        alert('Tokens listed successfully!');
        fetchMarketplaceListings();
    } catch (error) {
        console.error(error);
        alert('Failed to list tokens.');
    }
}

async function connectWallet() {
    if (await checkTronLinkInstalled()) {
        await initializeTronWeb();
    } else {
        console.log('Please install TronLink extension in your browser.');
    }
}

async function refreshUI() {
    try {
        const balance = await tronWeb.trx.getBalance(userAddress);
        updateUI(balance);

        document.getElementById('stake-amount').value = '';
        document.getElementById('buy-amount').value = '';
        document.getElementById('tokenAmount').value = '';
        document.getElementById('pricePerTokenInTRX').value = '';
    } catch (error) {
        console.error('Error refreshing UI:', error);
    }
}

function formatNumber(num) {
    return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatWholeNumber(num) {
    return Math.floor(parseFloat(num)).toLocaleString('en-US');
}

function formatAPR(apr) {
    return (parseFloat(apr) / 10000).toFixed(2);
}


  </script>
</body>
</html>
