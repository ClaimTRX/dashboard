<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body {
            background-color: #1a1a2e;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        .sidebar {
            height: 100vh;
            background-color: #162447;
            padding: 15px;
            position: fixed;
            width: 200px;
        }
        .sidebar a {
            color: #fff;
            text-decoration: none;
            display: block;
            padding: 10px 0;
        }
        .sidebar a:hover {
            background-color: #1f4068;
        }
        .topbar {
            background-color: #162447;
            padding: 10px;
            text-align: right;
            margin-left: 200px;
        }
        .topbar button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            padding: 8px 16px;
        }
        .main-content {
            margin-left: 220px;
            padding: 20px;
        }
        .card {
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 20px;
        }
        .card-body {
            display: flex;
            flex-direction: column;
        }
        .card-title {
            font-size: 1.5rem;
        }
        .card-text {
            font-size: 1rem;
        }
        .btn-success, .btn-danger, .btn-primary {
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.875rem;
            padding: 8px 16px;
            width: 20%;
            margin-top: 10px;
        }
        .btn-danger {
            background-color: #ff4c4c;
        }
        .btn-primary {
            background-color: #007bff;
        }
        .form-control {
            width: 20%;
            padding: 8px;
            font-size: 0.875rem;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .card-explanation {
            margin-top: 10px;
            font-size: 0.875rem;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        @media (min-width: 768px) {
            .card-body {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
            .card-text-section {
                flex: 1;
                margin-right: 20px;
            }
            .card-explanation {
                flex: 1;
            }
        }
        @media (max-width: 767.98px) {
            .sidebar {
                height: auto;
                padding: 10px;
                width: 100%;
                position: relative;
            }
            .topbar {
                text-align: center;
                margin-left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .card-title {
                font-size: 1.25rem;
            }
            .card-text {
                font-size: 0.875rem;
            }
            .btn-success, .btn-danger, .btn-primary {
                font-size: 0.75rem;
                padding: 6px 12px;
                width: 100%;
            }
            .form-control {
                font-size: 0.75rem;
                padding: 6px;
                width: 100%;
            }
            .card-explanation {
                margin-top: 20px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronweb/dist/TronWeb.min.js"></script>
    <script>
        let tronWeb, userAddress, contract;

        const contractAddress = "TMUDuMwYd94M6k7bhKgo6kqBKiDkjAFPDV";
        const contractABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_prizeWallet",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_ticketPrice",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "drawEnabled",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [],
                "name": "prizeWallet",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [],
                "name": "ticketPrice",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [],
                "name": "ticketsSold",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [],
                "name": "prizeAmount",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function",
                "constant": true
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_newPrizeWallet",
                        "type": "address"
                    }
                ],
                "name": "updatePrizeWallet",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "buyTickets",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "drawWinner",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdrawTRX",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getTickets",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        document.addEventListener('DOMContentLoaded', async () => {
            if (await checkTronLinkInstalled()) {
                await initializeTronWeb();
            }
        });

        async function checkTronLinkInstalled() {
            return new Promise((resolve) => {
                const interval = setInterval(() => {
                    if (window.tronWeb && window.tronWeb.defaultAddress.base58) {
                        clearInterval(interval);
                        resolve(true);
                    }
                }, 1000);
            });
        }

        async function initializeTronWeb() {
            tronWeb = window.tronWeb;
            userAddress = tronWeb.defaultAddress.base58;

            document.getElementById('connect-button').innerText = 'Connected';
            document.getElementById('connect-button').disabled = true;

            console.log('Connected to TronLink.');
            console.log('User Address:', userAddress);

            try {
                const balance = await tronWeb.trx.getBalance(userAddress);
                console.log('Balance:', tronWeb.fromSun(balance), 'TRX');

                contract = await tronWeb.contract(contractABI, contractAddress);

                updateUI(balance);
            } catch (error) {
                console.error('Error fetching balance:', error);
            }
        }

        async function updateUI(balance) {
            try {
                updateLotteryUI();
                updateAvailableTRX(balance);
                setupEventListeners();
            } catch (error) {
                console.error('Error updating UI:', error);
            }
        }

        async function updateLotteryUI() {
            try {
                const ticketsSold = await contract.methods.ticketsSold().call();
                const prizeAmount = await contract.methods.prizeAmount().call();
                console.log('Tickets Sold:', ticketsSold);
                console.log('Prize Amount:', prizeAmount);

                document.getElementById('ticketsSold').innerText = `Tickets sold: ${ticketsSold}`;
                document.getElementById('prizeAmount').innerText = `Current prize: ${tronWeb.fromSun(prizeAmount)} TRX`;

                const drawButton = document.getElementById('drawButton');
                if (ticketsSold >= 25) {
                    drawButton.disabled = false;
                    drawButton.classList.remove('disabled');
                } else {
                    drawButton.disabled = true;
                    drawButton.classList.add('disabled');
                }

                const ticketsCount = await contract.methods.getTickets(userAddress).call();
                document.getElementById('ticketsCount').innerText = `Your tickets: ${ticketsCount}`;
            } catch (error) {
                console.error('Error updating lottery UI:', error);
            }
        }

        function updateAvailableTRX(balance) {
            document.getElementById('available-trx').innerText = 'Available TRX: ' + formatNumber(tronWeb.fromSun(balance)) + ' TRX';
        }

        function setupEventListeners() {
            document.getElementById('buyTicketsForm').addEventListener('submit', (event) => {
                event.preventDefault();
                buyTickets();
            });
            document.getElementById('drawButton').addEventListener('click', drawWinner);
        }

        async function buyTickets() {
            try {
                const amount = document.getElementById('ticketAmount').value;
                const ticketPrice = await contract.methods.ticketPrice().call();
                const totalCost = ticketPrice * amount;

                await contract.methods.buyTickets(amount).send({
                    from: tronWeb.defaultAddress.base58,
                    callValue: totalCost
                });

                setTimeout(updateLotteryUI, 3000);
            } catch (error) {
                console.error('Error buying tickets:', error);
            }
        }

        async function drawWinner() {
            try {
                await contract.methods.drawWinner().send({
                    from: tronWeb.defaultAddress.base58
                });

                setTimeout(updateLotteryUI, 3000);
            } catch (error) {
                console.error('Error drawing winner:', error);
            }
        }

        async function connectWallet() {
            if (await checkTronLinkInstalled()) {
                await initializeTronWeb();
            } else {
                console.log('Please install TronLink extension in your browser.');
            }
        }

        function formatNumber(num) {
            return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</head>
<body>
    <div class="sidebar">
        <h2>CFT Token</h2>
        <a href="index.html">CFT Token</a>
        <a href="lottery.html">Lottery</a>
        <a href="draw.html">Draw</a>
        <a href="claim.html">Claim (Coming Soon)</a>
    </div>
    <div class="topbar">
        <button id="connect-button" onclick="connectWallet()">Connect Wallet</button>
    </div>
    <div class="main-content">
        <h1>Lottery</h1>
        <div class="card mt-4">
            <div class="card-body">
                <div class="card-text-section">
                    <h5 class="card-title">10 TRX Lottery</h5>
                    <div id="lotteryWarningMessage" class="card-text" style="color: red; display: none;">To participate, please have 10 TRX unstaked in your wallet.</div>
                    <div id="lotteryStatusMessage" class="card-text hidden" style="color: green;"></div>
                    <form id="buyTicketsForm">
                        <input type="number" id="ticketAmount" min="1" required placeholder="Amount of tickets"><br>
                        <button type="submit" class="btn btn-success">Buy Tickets</button>
                    </form>
                    <button id="drawButton" class="btn btn-primary disabled" disabled>Draw Winner</button>
                    <div id="prizeAmount">Current prize: 0 TRX</div>
                    <div id="ticketsSold">Tickets sold: 0</div>
                    <div id="ticketsCount">Your tickets: 0</div>
                    <div id="visitText"><a href="https://explorer.just.money/address/TMUDuMwYd94M6k7bhKgo6kqBKiDkjAFPDV" target="_blank" rel="noopener noreferrer">Lottery Contract</a></div>
                </div>
                <div class="card-explanation">
                   <div>
    <p>Tickets cost 10 TRX each, and you can buy as many tickets as you like for each round.</p>
</div>
<div>
    <p>The draw button is enabled once a minimum of 25 tickets are sold, ensuring a minimum prize of 187.5 TRX.<br> However, the draw will only occur when someone presses the draw button after it is enabled.</p>
</div>
<div>
    <p>75% of the ticket sales go to the winner, and the remaining 25% is used to buy and burn CFT.</p>
</div>
<div>
    <p>The contract owner covers energy fees, so only bandwidth costs will be taken from the user.</p>
</div>

                </div>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-body">
                <div class="card-text-section">
                    <h5 class="card-title">50 TRX Lottery (Coming Soon)</h5>
                    <div id="lotteryStatusMessage2" class="card-text hidden" style="color: green;"></div>
                    <button class="btn btn-success disabled" disabled>Buy Tickets</button><br>
                    <button class="btn btn-primary disabled" disabled>Draw Winner</button>
                    <div id="prizeAmount2">Current prize: Coming Soon</div>
                    <div id="ticketsSold2">Tickets sold: Coming Soon</div>
                    <div id="ticketsCount2">Your tickets: Coming Soon</div>
                </div>
                <div class="card-explanation">
                    <div>
    <p>Tickets cost 50 TRX each, and you can buy as many tickets as you like for each round.</p>
</div>
<div>
    <p>The draw button is enabled once a minimum of 25 tickets are sold, ensuring a minimum prize of 937.5 TRX.<br> However, the draw will only occur when someone presses the draw button after it is enabled.</p>
</div>
<div>
    <p>75% of the ticket sales go to the winner, and the remaining 25% is used to buy and burn CFT.</p>
</div>
<div>
    <p>The contract owner covers energy fees, so only bandwidth costs will be taken from the user.</p>
</div>

                </div>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-body">
                <div class="card-text-section">
                    <h5 class="card-title">100 TRX Lottery (Coming Soon)</h5>
                    <div id="lotteryStatusMessage3" class="card-text hidden" style="color: green;"></div>
                    <button class="btn btn-success disabled" disabled>Buy Tickets</button><br>
                    <button class="btn btn-primary disabled" disabled>Draw Winner</button>
                    <div id="prizeAmount3">Current prize: Coming Soon</div>
                    <div id="ticketsSold3">Tickets sold: Coming Soon</div>
                    <div id="ticketsCount3">Your tickets: Coming Soon</div>
                </div>
                <div class="card-explanation">
                    <div>
    <p>Tickets cost 100 TRX each, and you can buy as many tickets as you like for each round.</p>
</div>
<div>
    <p>The draw button is enabled once a minimum of 25 tickets are sold, ensuring a minimum prize of 1875 TRX. <br>However, the draw will only occur when someone presses the draw button after it is enabled.</p>
</div>
<div>
    <p>75% of the ticket sales go to the winner, and the remaining 25% is used to buy and burn CFT.</p>
</div>
<div>
    <p>The contract owner covers energy fees, so only bandwidth costs will be taken from the user.</p>
</div>

                </div>
            </div>
        </div>
    </div>
</body>
</html>
